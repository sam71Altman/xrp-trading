TASK: v4.6.PRO â€“ CRITICAL STATE UNIFICATION FIX (NO PATCHES)
This is NOT a feature request.
This is NOT a workaround.
This is a ROOT ARCHITECTURE FIX.
We detected STATE DIVERGENCE:
Symptoms:
UI shows: no open trade
Diagnosis shows: trade open
No close notification sent
PnL appears immediately at entry
New trades blocked
This PROVES: âŒ Multiple state sources exist âŒ More than one position_open âŒ Some components use cached/local state âŒ Not all closes pass through atomic engine
This is STRICTLY FORBIDDEN.
We must enforce:
ğŸ‘‰ ONE SINGLE SOURCE OF TRUTH ONLY
=====================================
HARD REQUIREMENTS (MANDATORY)
=====================================
RULE 1 â€” ONLY ENGINE OWNS POSITION STATE
There must be EXACTLY ONE:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
engine._position_state
Allowed:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

read â†’ engine.get_position()
write â†’ engine.execute_trade_atomically()
write â†’ engine.close_trade_atomically()
Forbidden everywhere else:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

self.position_open
paper_state
safety_core.state
local flags
cached state
copies
mirrors
If found â†’ DELETE.
RULE 2 â€” GLOBAL SEARCH & DESTROY
Perform FULL project scan and REMOVE:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

position_open
active_trade
current_trade
in_position
paper_position
safety_state
trade_state
cached_state
If not inside engine core â†’ REMOVE or redirect.
Replace ALL reads with:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
engine.get_position_state()
RULE 3 â€” SINGLE CLOSE PATH (CRITICAL)
ALL closes MUST go through:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
close_trade_atomically()
Forbidden:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

force_close_trade()
paper_close()
runner_exit()
kill_switch_exit()
direct state change
They must ONLY call:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
await engine.close_trade_atomically(reason)
No exceptions.
RULE 4 â€” DIAGNOSIS & UI MUST READ ENGINE ONLY
Diagnosis panel:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

MUST NOT read internal variables
MUST NOT keep its own state
Must use:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
engine.get_position_state()
UI: Same rule.
No local tracking allowed.
RULE 5 â€” REMOVE ALL CACHING
Forbidden:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

self.last_position
self.cached_position
self.paper_position
copy.deepcopy(state)
Everything must be live-read from engine.
RULE 6 â€” ATOMIC STATE RESET
Inside:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
close_trade_atomically()
MANDATORY ORDER:
broker close
update engine state
update DB/UI
send telegram
audit log
Never change order.
RULE 7 â€” REAL-TIME CONSISTENCY CHECK
Inside engine:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
async def _state_guard_loop():
    while True:
        ui = get_ui_state()
        engine_state = self.get_position_state()
        db = get_db_state()

        if not (ui == engine_state == db):
            await self.emergency_halt("STATE DIVERGENCE")

        await asyncio.sleep(0.1)
If mismatch â†’ STOP trading immediately.
=====================================
VALIDATION TESTS (MUST PASS)
=====================================
Test 1: 1000 signals â†’ only 1 trade
Test 2: every close â†’ exactly 1 telegram message
Test 3: UI == Diagnosis == Engine ALWAYS
Test 4: search project: ZERO extra position variables
Test 5: remove any secondary state containers
=====================================
EXPECTED RESULT
=====================================
After fix:
âœ… UI always matches diagnosis
âœ… close always sends message
âœ… no ghost trades
âœ… no stuck trades
âœ… no state drift
âœ… single truth only
If more than ONE state exists â†’ FAIL build.