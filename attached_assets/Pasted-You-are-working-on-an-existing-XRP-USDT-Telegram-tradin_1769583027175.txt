You are working on an existing XRP/USDT Telegram trading bot.
The bot logic and strategy are CORRECT and MUST NOT be changed.
This task is a pure accounting, balance, and trade logging bug fix.
ğŸš¨ PROBLEM SUMMARY (CONFIRMED BUG)
The bot:
Executes paper trades correctly
Opens and closes positions
Displays % gains correctly
BUT:
Shows $0.00 profit on winning trades
Balance sometimes decreases after profitable trades
Trade history shows correct % but incorrect PnL
Aggregated performance stats are wrong
â¡ï¸ This is a desynchronization bug between:
trade execution
PnL calculation
balance update
trade history persistence
âŒ WHAT MUST NOT CHANGE (STRICT)
Do NOT modify:
Entry logic
Exit logic
Aggressive mode
Score system
Risk logic
Position sizing logic
Trade frequency
Strategy behavior
Indicators
Cooldowns
Telegram UI
Commands or buttons
âš ï¸ This is NOT a strategy update.
âœ… OBJECTIVE
Fix only:
PnL calculation
Balance updates
Trade logging consistency
Trade history accuracy
Performance aggregation accuracy
ğŸ§  ROOT CAUSE (LIKELY)
One or more of the following bugs exist:
position_size or quantity is zero or rounded to zero before PnL calc
PnL is calculated as % only, not absolute USDT value
Balance update happens before PnL is calculated
Balance variable is overwritten instead of incremented
Trade history reads from a different variable than balance
CSV / storage writes incorrect or partial data
Float â†’ int conversion truncates values
Trade closes without committing PnL to state
ğŸ› ï¸ REQUIRED FIXES (MANDATORY)
1ï¸âƒ£ Enforce Valid Position Size
Before executing any paper trade:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
assert position_size > 0
assert quantity > 0
If not:
Abort trade execution
Log warning
Do NOT open trade
2ï¸âƒ£ Correct PnL Calculation (ABSOLUTE VALUE)
PnL MUST be calculated as:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
pnl = (exit_price - entry_price) * quantity
âŒ Do NOT calculate profit from percentage alone
3ï¸âƒ£ Correct Balance Update Order
Balance update MUST occur after trade close:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
balance = balance + pnl
NOT:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
balance = pnl
4ï¸âƒ£ Single Source of Truth
Ensure ALL of the following read from the same state:
Current balance
Trade history
Performance summary
Telegram output
No duplicate balance variables allowed.
5ï¸âƒ£ Trade History Integrity
Each closed trade MUST persist:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Json
{
  "timestamp": "...",
  "symbol": "XRP/USDT",
  "entry_price": float,
  "exit_price": float,
  "quantity": float,
  "pnl_usdt": float,
  "pnl_percent": float,
  "balance_after": float,
  "exit_reason": "TP | SL | EMA_EXIT | MANUAL"
}
6ï¸âƒ£ Precision Handling
Use float throughout
Do NOT round before PnL calc
Round only for display
Preserve at least 6 decimal precision internally
7ï¸âƒ£ Performance Aggregation Fix
Stats MUST be derived from actual trade records, not recalculated:
total profit
win/loss count
drawdown
equity curve
last N trades summary
8ï¸âƒ£ Validation (MANDATORY)
After fix, verify:
Winning trades increase balance
Losing trades decrease balance
Trade history PnL matches balance delta
Sum of trade PnL = balance change
No $0.00 profit on non-zero % trades
ğŸ§ª TEST CASE (MUST PASS)
Simulate:
BASE_SIZE = 100 USDT
Entry = 1.9000
Exit = 1.9050
Quantity â‰ˆ 52.63 XRP
Expected:
pnl â‰ˆ +0.26 USDT
balance increases accordingly
trade history logs correct values
ğŸ·ï¸ VERSION TAG
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
VERSION = "3.6.1 â€“ Accounting & Trade Logging Fix"
ğŸ”’ FINAL NOTE
This fix is non-negotiable and must not affect trading behavior.
If any logic or performance changes are introduced â†’ rollback and retry.
âœ… DELIVERABLE
Correct balance updates
Correct trade logs
Accurate stats
No UI or logic changes