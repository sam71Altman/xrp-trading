You are fixing a confirmed critical accounting bug.
The trading logic is correct.
Signals, entries, exits, and trailing SL are working correctly.
The bug is 100% related to quantity & PnL calculation during trade close, especially for Trailing SL exits.
ğŸš¨ CONFIRMED SYMPTOM
Trades close with:
Positive price movement
Correct exit reason (Trailing SL)
BUT:
pnl_usdt = 0
pnl_percent = 0
Balance sometimes decreases
This is mathematically impossible unless quantity == 0 or not used.
âŒ STRICT RULE
DO NOT change:
Strategy
Trailing SL logic
Entry/exit conditions
Aggressive mode
Speed
Risk rules
This is NOT a strategy update.
âœ… REQUIRED FIXES (MANDATORY)
1ï¸âƒ£ Freeze Quantity at Entry (CRITICAL)
At trade entry:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
trade.quantity = calculated_quantity
trade.position_size = used_usdt
These values MUST be immutable and stored inside the trade object.
2ï¸âƒ£ Use Frozen Quantity at Close (NO RE-CALCULATION)
At trade close (ANY reason, including Trailing SL):
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
pnl = (exit_price - trade.entry_price) * trade.quantity
âŒ Do NOT recalculate quantity
âŒ Do NOT use current price sizing
âŒ Do NOT use percentage-only logic
3ï¸âƒ£ Trailing SL MUST Use Same Close Path
Trailing SL must call the SAME close function as TP/SL:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
close_trade(trade, reason="TRAILING_SL")
And that function MUST:
Use trade.quantity
Use trade.entry_price
4ï¸âƒ£ Balance Update MUST Be Incremental
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
balance = balance + pnl
âŒ Never overwrite balance
âŒ Never reset balance on close
5ï¸âƒ£ Logging Validation (Hard Check)
Before saving trade:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
assert trade.quantity > 0
assert abs(pnl) > 0 or trade.exit_price == trade.entry_price
If assertion fails:
Log error
Do NOT save trade
Do NOT update balance
6ï¸âƒ£ Display Logic (Cosmetic Only)
Round ONLY for display:
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
display_pnl = round(pnl, 2)
display_percent = round((pnl / trade.position_size) * 100, 2)
Internal values remain full precision.
ğŸ§ª MANDATORY TEST
Simulate Trailing SL trade:
Entry: 1.9289
Exit: 1.9305
Position: 100 USDT
Expected:
pnl â‰ˆ +0.08 USDT
balance increases
trade history reflects profit
NO zero-profit display
ğŸ·ï¸ VERSION
Ù†Ø³Ø® Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
Python
VERSION = "3.6.2 â€“ Trailing SL Quantity & PnL Fix"
ğŸš« FAILURE CONDITION
If after this fix:
Any profitable trade shows +0.00 USDT â†’ STOP and report failure.